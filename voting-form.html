<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steel City 50 2025 Voting</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0d9488 0%, #0f766e 50%, #0e7490 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #1f2937;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        input[type="email"],
        input[type="text"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #0d9488;
        }

        select {
            background-color: white;
            cursor: pointer;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            padding-left: 40px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .counter {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0d9488;
            margin-bottom: 15px;
        }

        .selections-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .song-item {
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
        }

        .song-item:hover {
            background: #f3f4f6;
        }

        .song-item.selected {
            background: #ccfbf1;
            border-color: #0d9488;
        }

        .song-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .song-info {
            flex: 1;
        }

        .song-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .song-artist {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .selected-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #ccfbf1;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .selected-number {
            font-size: 1.3rem;
            font-weight: bold;
            color: #0d9488;
            min-width: 30px;
        }

        .selected-info {
            flex: 1;
        }

        .custom-badge {
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0d9488, #0e7490);
            color: white;
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.4);
        }

        .btn-primary:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #3b82f6;
            color: white;
        }

        .btn-secondary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-remove {
            background: #ef4444;
            color: white;
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .btn-remove:hover {
            background: #dc2626;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-error {
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #991b1b;
        }

        .alert-warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            color: #92400e;
        }

        .custom-form {
            display: none;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
            margin-top: 20px;
        }

        .custom-form.show {
            display: block;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        .success-screen {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .success-screen.show {
            display: block;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 3rem;
        }

        .vote-card {
            background-image: url('./steel-city-votes-bg.jpg');
            background-size: contain;
            background-position: center;
            border-radius: 16px;
            padding: 180px 40px 100px;
            max-width: 600px;
            margin: 20px auto;
            color: white;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            position: relative;
            min-height: 800px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .vote-card h3,
        .vote-card .title-script,
        .vote-card .subtitle {
            display: none;
        }

        .vote-card .subtitle {
            display: none;
        }

        .vote-list {
            background: transparent;
            border-radius: 0;
            padding: 0;
            margin-bottom: 0;
        }

        .vote-list-item {
            padding: 8px 15px;
            margin-bottom: 6px;
            background: transparent;
            border-left: none;
            border-radius: 0;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .vote-list-item:last-child {
            margin-bottom: 0;
        }

      
        .vote-track {
            flex: 1;
        }

        .vote-track-title {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 2px;
            color: #ffffff;
            line-height: 1.1;
        }

        .vote-track-artist {
            opacity: 1;
            font-size: 0.85rem;
            color: #ffffff;
            line-height: 1.1;
        }

        .download-btn {
            background: white;
            color: #0d9488;
            padding: 14px 28px;
            border-radius: 8px;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px auto 0;
            transition: all 0.3s;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .loading-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ Steel City 50 2025 Voting</h1>
            <div style="max-width: 800px; margin: 0 auto; text-align: left; background: rgba(255,255,255,0.1); padding: 25px; border-radius: 12px; margin-top: 20px;">
                <p style="font-size: 1rem; line-height: 1.6; margin-bottom: 15px;">
                    It's that time of year where we have to make the hard decision and pick our top 10 tracks of the 2025.
                </p>
                <p style="font-size: 1rem; line-height: 1.6; margin-bottom: 15px;">
                    The past 12 months have been filled with top notch releases from all of our favourite local artists. Some were first timers and others hiatus ending drops, no matter the circumstance we love them all!
                </p>
                <p style="font-size: 1rem; line-height: 1.6; margin-bottom: 15px;">
                    So please choose carefully and don't forget to share your picks!
                </p>
                <p style="font-size: 1.1rem; font-weight: 600; margin-bottom: 5px;">
                    The results will be broadcast on New Years Eve 12PM-4PM on newcastlemusicshow.com
                </p>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <p style="font-size: 1rem; font-weight: 600; margin-bottom: 12px;">Voting Guidelines:</p>
                    <ul style="font-size: 0.95rem; line-height: 1.7; padding-left: 20px;">
                        <li>Only songs released from December 1st 2024 to November 30th 2025 are eligible to be voted for</li>
                        <li>Artist/at least half of the band must either:
                            <ul style="margin-top: 8px; margin-bottom: 8px;">
                                <li>A) reside within the greater Newcastle, Hunter, Central Coast region currently or</li>
                                <li>B) be from the Greater Newcastle, Hunter, Central Coast region</li>
                            </ul>
                        </li>
                        <li>A minimum of 5, and maximum of 10 tracks may be voted for</li>
                        <li>If the track/s you want to vote for isn't on the list, add it/them via the 'add tracks' section.</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="mainForm">
            <!-- Email Section -->
            <div class="card">
                <h2>Your Details</h2>
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="nameInput" placeholder="Your name" required>
                </div>
                
                <div class="form-group">
                    <label>Postcode *</label>
                    <input type="text" id="postcodeInput" placeholder="e.g. 2300" required>
                </div>
                
                <div class="form-group">
                    <label>Age Range *</label>
                    <select id="ageRangeSelect" required>
                        <option value="">Select age range</option>
                        <option value="<18">&lt;18</option>
                        <option value="18-24">18-24</option>
                        <option value="25-34">25-34</option>
                        <option value="35-44">35-44</option>
                        <option value="45-54">45-54</option>
                        <option value="55-64">55-64</option>
                        <option value="65+">65+</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Email Address *</label>
                    <input type="email" id="emailInput" placeholder="your@email.com" required>
                    <div id="votedAlert" class="alert alert-error">
                        <strong>Already Voted</strong><br>
                        This email address has already been used to vote. Each person can only vote once.
                    </div>
                </div>
            </div>

            <!-- Selections Display -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;"><span id="selectionCounter" class="counter">Your Selections (0/10)</span></h2>
                    <button class="btn btn-secondary" onclick="saveShortlist()">üíæ Save</button>
                </div>
                <div id="selectionsList" class="selections-list">
                    <div class="empty-state">No tracks selected yet. Start building your list below!</div>
                </div>
            </div>

            <!-- Available Tracks -->
            <div class="card">
                <h2>Available Tracks</h2>
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" placeholder="Search by artist or track name...">
                </div>
                <div id="songsList" class="selections-list">
                    <div class="loading-state">Loading tracks...</div>
                </div>
            </div>

            <!-- Custom Tracks -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Add Custom Tracks (<span id="customCount">0</span>/5)</h2>
                    <button class="btn btn-success" onclick="toggleCustomForm()" id="addCustomBtn">‚ûï Add Track</button>
                </div>
                
                <div id="customForm" class="custom-form">
                    <div class="form-group">
                        <label>Artist Name</label>
                        <input type="text" id="customArtist" placeholder="Enter artist name">
                    </div>
                    <div class="form-group">
                        <label>Track Title</label>
                        <input type="text" id="customTitle" placeholder="Enter track title">
                    </div>
                    <div class="button-group">
                        <button class="btn btn-success" onclick="addCustomSong()" style="flex: 1;">Add to List</button>
                        <button class="btn" onclick="toggleCustomForm()" style="background: #e5e7eb; color: #374151;">Cancel</button>
                    </div>
                </div>
                
                <p style="color: #6b7280; font-size: 0.9rem; margin-top: 15px;">
                    Can't find a track in our list? Add up to 5 of your own selections.
                </p>
            </div>

            <!-- Submit Button -->
            <div class="card">
                <button class="btn btn-primary" id="submitBtn" onclick="submitVote()" disabled>
                    üì§ Submit Your Vote
                </button>
                <p style="text-align: center; color: #6b7280; font-size: 0.9rem; margin-top: 15px;">
                    One vote per person. Select between 5-10 tracks. Voting closes December 28th at midnight.
                </p>
            </div>
        </div>

        <!-- Success Screen -->
        <div id="successScreen" class="success-screen">
            <div class="card">
                <div class="success-icon">‚ù§Ô∏è</div>
                <h2 style="font-size: 2.5rem; margin-bottom: 15px;">Vote Submitted!</h2>
                <p style="font-size: 1.1rem; color: #6b7280; margin-bottom: 10px;">Thank you for participating in Steel City 50.</p>
                <p style="color: #9ca3af; margin-bottom: 30px;">Your <span id="totalCount"></span> track(s) have been recorded.</p>
                
                <!-- Vote Card for Image -->
                <div id="voteCard" class="vote-card">
                    <div id="voteListForImage" class="vote-list"></div>
                </div>

                <button class="download-btn" onclick="downloadVoteImage()">
                    <span style="font-size: 1.3rem;">üì∏</span>
                    Save as Image
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const MAX_SELECTIONS = 10;
        const MAX_CUSTOM = 5;
        const MIN_SELECTIONS = 5;
        
        // IMPORTANT: Use TWO different sheets!
        // 1. VOTES_SCRIPT_URL - Your NEW Votes Sheet's Apps Script URL (for writing votes)
        // 2. TRACKS_SHEET_ID - Your existing Tracks Sheet ID (for reading tracks)
        
        const VOTES_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzngi6DptguRQiFL0bqiAV0i_Dui7VxNckeQlQ1y_Mf5IBi-UfKifDKZODOj7_6cPJt/exec';
        const TRACKS_SHEET_ID = '1bBkfFxw5I2aNVxWTknl6XSYHJj6nqQD5pKk_MAXQ368';

        // Steel City 50 2025 Track List
        // Add preview URLs to your tracks (optional)
        let allSongs = [
            { id: 1, artist: "198archie", title: "So Easy", previewUrl: "" },
            { id: 2, artist: "198archie", title: "Tracing Thru Sand", previewUrl: "" },
            { id: 3, artist: "198archie;Banjo Ulysses", title: "A Day in the Life", previewUrl: "" },
            { id: 4, artist: "4K Death Dream", title: "iCarly", previewUrl: "" },
            { id: 5, artist: "4K Death Dream;Craterface", title: "Acid Drops", previewUrl: "" },
            { id: 6, artist: "Allan Parmenter;Adam Miller", title: "Smoky Bar", previewUrl: "" },
            { id: 7, artist: "Arietta", title: "Bittersweet", previewUrl: "" },
            { id: 8, artist: "ASCN", title: "A Waking Tomorow", previewUrl: "" },
            { id: 9, artist: "Aunty Alan", title: "freEzer", previewUrl: "" },
            { id: 10, artist: "Aunty Alan", title: "jasmine's flower", previewUrl: "" },
            { id: 11, artist: "Baby Bruh", title: "BBTV-1", plays: 0 },
            { id: 12, artist: "Baby Bruh", title: "LOVE-LETTER 2 NEWCASTLE", plays: 0 },
            { id: 13, artist: "Baby Bruh", title: "sAdevinyl:)", plays: 0 },
            { id: 14, artist: "Baby Bruh", title: "TRICKS + SKILLS", plays: 0 },
            { id: 15, artist: "Baby Bruh", title: "ANDREW AND DANIEL", plays: 0 },
            { id: 16, artist: "Baby Bruh;Dobbie", title: "rock on baby bruh, follow your heart until the bitter end (RABBLEROUSIN') - Special Version", plays: 0 },
            { id: 17, artist: "Baby Bruh;Dobbie", title: "letterZ (lift0ff)", plays: 0 },
            { id: 18, artist: "Baby Bruh;Ruumi", title: "SEIKO BOYZ", plays: 0 },
            { id: 19, artist: "Baby Bruh;sinkholecrim;Banjo Ulysses;The Moc", title: "i lost myself and realised it was supposed to happen", plays: 0 },
            { id: 20, artist: "Banjo Ulysses", title: "Boring", plays: 0 },
            { id: 21, artist: "Banjo Ulysses", title: "Jet Set", plays: 0 },
            { id: 22, artist: "Banjo Ulysses", title: "Sky", plays: 0 },
            { id: 23, artist: "Banjo Ulysses", title: "Get Lost", plays: 0 },
            { id: 24, artist: "Banjo Ulysses", title: "The Biggest Flex Anyone Will Ever Have Is Dying", plays: 0 },
            { id: 25, artist: "Banjo Ulysses", title: "Window", plays: 0 },
            { id: 26, artist: "Banjo Ulysses", title: "NYE", plays: 0 },
            { id: 27, artist: "Beep Test", title: "Get It Right", plays: 0 },
            { id: 28, artist: "Beep Test", title: "Alone", plays: 0 },
            { id: 29, artist: "Boudicca", title: "Serpentine", plays: 0 },
            { id: 30, artist: "Boudicca", title: "Boys in Town", plays: 0 },
            { id: 31, artist: "c_h_l__o_e", title: "neural", plays: 0 },
            { id: 32, artist: "c_h_l__o_e", title: "Wahluu", plays: 0 },
            { id: 33, artist: "C.O.B.B.", title: "icky gooey sticky", plays: 0 },
            { id: 34, artist: "Cacti Moon", title: "The Murder", plays: 0 },
            { id: 35, artist: "Camino Gold", title: "Sweet Pea", plays: 0 },
            { id: 36, artist: "Carnivara", title: "CULDESAC", plays: 0 },
            { id: 37, artist: "Carnivara", title: "Rhumba", plays: 0 },
            { id: 38, artist: "Caster", title: "To See Is to Rot", plays: 0 },
            { id: 39, artist: "CATPISS", title: "Beauty Regime", plays: 0 },
            { id: 40, artist: "CATPISS", title: "Coffin Nails", plays: 0 },
            { id: 41, artist: "CENTRAL", title: "masks", plays: 0 },
            { id: 42, artist: "CENTRAL", title: "Visions", plays: 0 },
            { id: 43, artist: "CENTRAL", title: "I.D", plays: 0 },
            { id: 44, artist: "CENTRAL", title: "Solid", plays: 0 },
            { id: 45, artist: "Charlie Farmer", title: "AGE", plays: 0 },
            { id: 46, artist: "Cheap Delusions", title: "In My Dreams", plays: 0 },
            { id: 47, artist: "CLUTCH KICK", title: "DISRESPECTED", plays: 0 },
            { id: 48, artist: "Collector", title: "Brick Silo", plays: 0 },
            { id: 49, artist: "Conflikt", title: "WEIRDO", plays: 0 },
            { id: 50, artist: "Cormac Grant", title: "Montr√©al", plays: 0 },
            { id: 51, artist: "Cormac Grant", title: "Threadbare", plays: 0 },
            { id: 52, artist: "Cutthroat", title: "Forever Nothing", plays: 0 },
            { id: 53, artist: "Daisy Chain", title: "Stranger In The Skin", plays: 0 },
            { id: 54, artist: "Daisy Chain", title: "Pig House", plays: 0 },
            { id: 55, artist: "Dane Tutty", title: "Happy", plays: 0 },
            { id: 56, artist: "Dane Tutty", title: "Not The Date", plays: 0 },
            { id: 57, artist: "Dane Tutty", title: "What a horrible mess", plays: 0 },
            { id: 58, artist: "dayhaze", title: "break down", plays: 0 },
            { id: 59, artist: "Dead Mall", title: "GASOLINE", plays: 0 },
            { id: 60, artist: "Dead Mall", title: "PROPERTY DAMAGE", plays: 0 },
            { id: 61, artist: "Dead Mall", title: "EVICTION NIGHT", plays: 0 },
            { id: 62, artist: "Dead Mall", title: "100% PURE POISON", plays: 0 },
            { id: 63, artist: "Dead Mall", title: "CORRIDOR VIOLENCE", plays: 0 },
            { id: 64, artist: "Dead Mall", title: "SUPERLIMINAL", plays: 0 },
            { id: 65, artist: "Deadshowws", title: "I Should", plays: 0 },
            { id: 66, artist: "Deadshowws", title: "Summer Rust", plays: 0 },
            { id: 67, artist: "Deadshowws", title: "Wallflower", plays: 0 },
            { id: 68, artist: "Death Dance", title: "Disintegration", plays: 0 },
            { id: 69, artist: "Dipodium", title: "Coagulate", plays: 0 },
            { id: 70, artist: "Discount Code", title: "Doomed Existence", plays: 0 },
            { id: 71, artist: "doris", title: "Every Hound", plays: 0 },
            { id: 72, artist: "Dr. Dankenstein", title: "Runnin Around Town", plays: 0 },
            { id: 73, artist: "dust", title: "Drawbacks", plays: 0 },
            { id: 74, artist: "dust", title: "Alastair", plays: 0 },
            { id: 75, artist: "dust", title: "Swamped", plays: 0 },
            { id: 76, artist: "e4444e", title: "Liberation", plays: 0 },
            { id: 77, artist: "e4444e", title: "Crutch", plays: 0 },
            { id: 78, artist: "e4444e", title: "Meaning", plays: 0 },
            { id: 79, artist: "e4444e", title: "Push the Dove", plays: 0 },
            { id: 80, artist: "Elestial", title: "The One Mistake", plays: 0 },
            { id: 81, artist: "False Persona;Mall Grab", title: "Crazy", plays: 0 },
            { id: 82, artist: "Fatal Excuse", title: "LETHAL DIVERSION", plays: 0 },
            { id: 83, artist: "Feel The Pain", title: "WAR WITHIN MYSELF", plays: 0 },
            { id: 84, artist: "Feel The Pain", title: "TURN TO DUST", plays: 0 },
            { id: 85, artist: "feign", title: "jealous", plays: 0 },
            { id: 86, artist: "feign", title: "behind closed doors", plays: 0 },
            { id: 87, artist: "feign", title: "slip away", plays: 0 },
            { id: 88, artist: "Foreign Horror", title: "Boys At The Back", plays: 0 },
            { id: 89, artist: "Fungas", title: "Knife 2 You", plays: 0 },
            { id: 90, artist: "Fungas", title: "Wandering Eye", plays: 0 },
            { id: 91, artist: "Fungas", title: "Granulate", plays: 0 },
            { id: 92, artist: "Fungas", title: "Spool", plays: 0 },
            { id: 93, artist: "G.A.G.", title: "Trying", plays: 0 },
            { id: 94, artist: "GARGOYLAR", title: "A Big Slug (BONUS TRACK, A CUT SONG FROM FREAK ROCK DEMOS)", plays: 0 },
            { id: 95, artist: "gauze", title: "What You Want", plays: 0 },
            { id: 96, artist: "Georgie Winchester;Nick Saxon", title: "Lighthouse", plays: 0 },
            { id: 97, artist: "Gidget Moon & The Stars", title: "Piscean Goddess", plays: 0 },
            { id: 98, artist: "Goblet", title: "Pixie Jive", plays: 0 },
            { id: 99, artist: "gr9lin;Duncan Woods", title: "Saltwater", plays: 0 },
            { id: 100, artist: "Grace Aberhart", title: "Gut Punch", plays: 0 },
            { id: 101, artist: "Grace Turner", title: "Don't Hold On", plays: 0 },
            { id: 102, artist: "gracee", title: "closest i've ever been to the moon", plays: 0 },
            { id: 103, artist: "gracee", title: "gumtrees", plays: 0 },
            { id: 104, artist: "gracee", title: "streams and days", plays: 0 },
            { id: 105, artist: "Grip Down", title: "The Dark Cloud", plays: 0 },
            { id: 106, artist: "Grooveworks;Half Cut;Who Is Arcadia", title: "Take A Little Trip", plays: 0 },
            { id: 107, artist: "Handsome Alice", title: "Satellites", plays: 0 },
            { id: 108, artist: "Herd Immunity", title: "A Place To Go", plays: 0 },
            { id: 109, artist: "Hey Lady!", title: "Go Quiet", plays: 0 },
            { id: 110, artist: "Hey Lady!", title: "Three More Times", plays: 0 },
            { id: 111, artist: "horse", title: "BLIGHT", plays: 0 },
            { id: 112, artist: "horse", title: "Headlights", plays: 0 },
            { id: 113, artist: "Ill Natured;Splinter", title: "We Still Remain", plays: 0 },
            { id: 114, artist: "Ironbark", title: "Scales", plays: 0 },
            { id: 115, artist: "Iryss", title: "Eventually", plays: 0 },
            { id: 116, artist: "Izaak Clifford", title: "D√©j√† Vu", plays: 0 },
            { id: 117, artist: "izzy t", title: "BANK STATEMENTS", plays: 0 },
            { id: 118, artist: "izzy t;Toekio", title: "LUNCH BREAK FREESTYLE", plays: 0 },
            { id: 119, artist: "Jacques Levy's Desire", title: "Lightning in a bottle", plays: 0 },
            { id: 120, artist: "Jacques Levy's Desire", title: "Fairweather", plays: 0 },
            { id: 121, artist: "Jacques Levy's Desire", title: "Romance In Rosengarten", plays: 0 },
            { id: 122, artist: "Jeff Benzos", title: "Gun Me Down", plays: 0 },
            { id: 123, artist: "jetpilot", title: "Taco bell", plays: 0 },
            { id: 124, artist: "Joel Leggett", title: "Should've Known Better", plays: 0 },
            { id: 125, artist: "Jordan Hunt;Dark Pattern", title: "Where Do I Belong?", plays: 0 },
            { id: 126, artist: "jyc.", title: "feels like summer", plays: 0 },
            { id: 127, artist: "Kelzy", title: "Old Memories", plays: 0 },
            { id: 128, artist: "Kofi Harara", title: "MONEY", plays: 0 },
            { id: 129, artist: "LavJav", title: "WasteTown", plays: 0 },
            { id: 130, artist: "Letters to Lions", title: "Spare Change", plays: 0 },
            { id: 131, artist: "louise101", title: "DRAIN", plays: 0 },
            { id: 132, artist: "Lucky Boys", title: "REAL LOVE", plays: 0 },
            { id: 133, artist: "Lucky Boys", title: "GO CHESTER", plays: 0 },
            { id: 134, artist: "Lucky Boys", title: "SEE THAT?", plays: 0 },
            { id: 135, artist: "LUPO.THEBOY", title: "Paris", plays: 0 },
            { id: 136, artist: "LUPO.THEBOY", title: "Far with Nothing", plays: 0 },
            { id: 137, artist: "Mall Grab", title: "New York", plays: 0 },
            { id: 138, artist: "Mall Grab", title: "The Way I'm Feeling", plays: 0 },
            { id: 139, artist: "Maple's Pet Dinosaur", title: "lego", plays: 0 },
            { id: 140, artist: "MAVS;ASHA", title: "Numb", plays: 0 },
            { id: 141, artist: "Me and Friends", title: "When I'm Ready", plays: 0 },
            { id: 142, artist: "Me Local Member Of Parliament", title: "champagne in my asshole", plays: 0 },
            { id: 143, artist: "Melvic Centre", title: "Exit Stage Left", plays: 0 },
            { id: 144, artist: "Melvic Centre", title: "Snake Oil", plays: 0 },
            { id: 145, artist: "Melvic Centre", title: "First to Know", plays: 0 },
            { id: 146, artist: "Midway", title: "Silhouette", plays: 0 },
            { id: 147, artist: "Midway", title: "Stitch Up", plays: 0 },
            { id: 148, artist: "Midway", title: "As It Is", plays: 0 },
            { id: 149, artist: "Midway", title: "Samsar", plays: 0 },
            { id: 150, artist: "Mishayla", title: "silver line", plays: 0 },
            { id: 151, artist: "Mishayla", title: "late night talking", plays: 0 },
            { id: 152, artist: "Mishayla", title: "the man", plays: 0 },
            { id: 153, artist: "Model Audio", title: "A.T.B.Y.D.", plays: 0 },
            { id: 154, artist: "Molly Millington", title: "Your Villain", plays: 0 },
            { id: 155, artist: "mycriesfallondeafears", title: "i ate a perc and thought i was batman", plays: 0 },
            { id: 156, artist: "nightdive", title: "Diviner", plays: 0 },
            { id: 157, artist: "Nina Romeru", title: "When You See Me - Live At Customs House", plays: 0 },
            { id: 158, artist: "Nina Romeru", title: "Good Goodbyes - Live At Customs House", plays: 0 },
            { id: 159, artist: "Ninajirachi", title: "All I Am", plays: 0 },
            { id: 160, artist: "Ninajirachi", title: "London Song", plays: 0 },
            { id: 161, artist: "Ninajirachi", title: "All At Once", plays: 0 },
            { id: 162, artist: "Ninajirachi", title: "Infohazard", plays: 0 },
            { id: 163, artist: "Ninajirachi", title: "Fuck My Computer", plays: 0 },
            { id: 164, artist: "Noah Church", title: "Speak Slowly", plays: 0 },
            { id: 165, artist: "OHNA", title: "RIGHT NOW SOMEHOW", plays: 0 },
            { id: 166, artist: "Old House", title: "Desks and Chairs", plays: 0 },
            { id: 167, artist: "Pocket Robot", title: "chewy under chairs", plays: 0 },
            { id: 168, artist: "POLTERGEIST 9000;Finlay Ross", title: "Higher Frequencies", plays: 0 },
            { id: 169, artist: "POLTERGEIST 9000;Finlay Ross", title: "Traks", plays: 0 },
            { id: 170, artist: "POLTERGEIST 9000;Finlay Ross", title: "Sonic Interruptions", plays: 0 },
            { id: 171, artist: "Ponzi Scheme", title: "Nightcrawler", plays: 0 },
            { id: 172, artist: "Quaid Pearce", title: "Hustlin", plays: 0 },
            { id: 173, artist: "Quaid Pearce", title: "I Need Ya Here", plays: 0 },
            { id: 174, artist: "Quaid Pearce", title: "Automatic", plays: 0 },
            { id: 175, artist: "Quaid Pearce", title: "Never Givin Up", plays: 0 },
            { id: 176, artist: "RAILS", title: "CONQUEST", plays: 0 },
            { id: 177, artist: "Red Room", title: "Late Night Tip", plays: 0 },
            { id: 178, artist: "Red Room", title: "Hustla Baby", plays: 0 },
            { id: 179, artist: "Resident.", title: "it was always you", plays: 0 },
            { id: 180, artist: "Robbie Thunder", title: "Only Tonite", plays: 0 },
            { id: 181, artist: "Robbie Thunder;Busted Head Racket", title: "BAD LUCK", plays: 0 },
            { id: 182, artist: "Rose White", title: "Vanilla", plays: 0 },
            { id: 183, artist: "Rose White", title: "Chocolate", plays: 0 },
            { id: 184, artist: "Rose White", title: "Bones", plays: 0 },
            { id: 185, artist: "Rose White", title: "Strawberry", plays: 0 },
            { id: 186, artist: "Rum Jungle", title: "Rocketship", plays: 0 },
            { id: 187, artist: "Rum Jungle", title: "What's It Like", plays: 0 },
            { id: 188, artist: "Rum Jungle", title: "Hi Hello", plays: 0 },
            { id: 189, artist: "Rum Jungle", title: "Notice", plays: 0 },
            { id: 190, artist: "Rum Jungle", title: "What's Next", plays: 0 },
            { id: 191, artist: "Rum Jungle", title: "Pass You By", plays: 0 },
            { id: 192, artist: "Ruumi", title: "Shareen (mestyle)", plays: 0 },
            { id: 193, artist: "Ruumi;Dobbie", title: "The Rocks", plays: 0 },
            { id: 194, artist: "Sammy Luka's Sundown Band", title: "I Am Content Staring Out My Window", plays: 0 },
            { id: 195, artist: "Sammy Luka's Sundown Band", title: "The Sound of the City", plays: 0 },
            { id: 196, artist: "Samuel Winder", title: "Dog", plays: 0 },
            { id: 197, artist: "Samuel Winder", title: "Dustbowl Disco", plays: 0 },
            { id: 198, artist: "Secret World", title: "Everywhere Now", plays: 0 },
            { id: 199, artist: "SHARKS! SHARKS! SHARKS!", title: "Luck? Never Heard Of Him", plays: 0 },
            { id: 200, artist: "Sheena Dali's Swedish Magazines", title: "Grey Hamburger", plays: 0 },
            { id: 201, artist: "Simba Monroe", title: "TRAGEDY", plays: 0 },
            { id: 202, artist: "Simba Monroe;IGGY CLUE", title: "BRAND NU", plays: 0 },
            { id: 203, artist: "SKELTER", title: "Dolphin", plays: 0 },
            { id: 204, artist: "Skorn", title: "You Won't Last", plays: 0 },
            { id: 205, artist: "Skyepaint", title: "Passenger", plays: 0 },
            { id: 206, artist: "Sondar", title: "Chemical Debt", plays: 0 },
            { id: 207, artist: "Soul Wun", title: "To Fly", plays: 0 },
            { id: 208, artist: "Soy", title: "Expired Plead", plays: 0 },
            { id: 209, artist: "Soyboy", title: "Slap!", plays: 0 },
            { id: 210, artist: "Spat Out", title: "Cold On Me", plays: 0 },
            { id: 211, artist: "Stagger", title: "Stagger", plays: 0 },
            { id: 212, artist: "Stagger", title: "HeadRip", plays: 0 },
            { id: 213, artist: "STEEL CITY SONICHU", title: "RIGHT NOW", plays: 0 },
            { id: 214, artist: "STEEL CITY SONICHU", title: "SNACK PACK", plays: 0 },
            { id: 215, artist: "STEEL CITY SONICHU;KA$H KETCHUM", title: "JUNGLE JUICE", plays: 0 },
            { id: 216, artist: "STEEL CITY SONICHU;PFIZER;MIKEY", title: "SEDITIONARIES", plays: 0 },
            { id: 217, artist: "Taki", title: "Dangerous", plays: 0 },
            { id: 218, artist: "The Axolotls", title: "Think Twice", plays: 0 },
            { id: 219, artist: "The Cheaks", title: "Talk It Out", plays: 0 },
            { id: 220, artist: "The FX42", title: "frank's apology", plays: 0 },
            { id: 221, artist: "The FX42", title: "pretty (far on foot)", plays: 0 },
            { id: 222, artist: "The Golden Gaytimes", title: "Cherries and Cheeses", plays: 0 },
            { id: 223, artist: "The Gooch Palms", title: "58d", plays: 0 },
            { id: 224, artist: "The Med Heads", title: "Malnutrition", plays: 0 },
            { id: 225, artist: "The Med Heads", title: "Sensitive", plays: 0 },
            { id: 226, artist: "The Night Slug", title: "Daddy's Home", plays: 0 },
            { id: 227, artist: "The Tryouts", title: "Truckin 'n' Fuckin", plays: 0 },
            { id: 228, artist: "The Tryouts", title: "Good Year", plays: 0 },
            { id: 229, artist: "Trophy Wyfe", title: "Come Around", plays: 0 },
            { id: 230, artist: "Trophy Wyfe", title: "Timing", plays: 0 },
            { id: 231, artist: "Volatile Ways", title: "Perfect Dark", plays: 0 },
            { id: 232, artist: "Volatile Ways", title: "Televised Suicide", plays: 0 },
            { id: 233, artist: "Volatile Ways", title: "God Will Be Cut", plays: 0 },
            { id: 234, artist: "WAY LIE", title: "Do You Wanna Die", plays: 0 },
            { id: 235, artist: "Wet Cigarette", title: "OWN WORST ENEMY", plays: 0 },
            { id: 236, artist: "where's jimmy", title: "Hanging On", plays: 0 },
            { id: 237, artist: "Wolfend√∂rf", title: "Beyond The Castle Grounds", plays: 0 },
            { id: 238, artist: "Wrenasmir", title: "Rh Vx", plays: 0 },
            { id: 239, artist: "yves sage hunter", title: "turn around", plays: 0 },
            { id: 240, artist: "yves sage hunter", title: "beach rip", plays: 0 },
            { id: 241, artist: "zoe davis", title: "38 harbour street", plays: 0 }
        ];
        
        let selectedSongs = [];
        let customSongs = [];
        let currentName = '';
        let currentPostcode = '';
        let currentAgeRange = '';
        let currentEmail = '';
        let hasVoted = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSongsFromSheet();
            loadSavedShortlist();
            
            document.getElementById('nameInput').addEventListener('input', handleFormChange);
            document.getElementById('postcodeInput').addEventListener('input', handleFormChange);
            document.getElementById('ageRangeSelect').addEventListener('change', handleFormChange);
            document.getElementById('emailInput').addEventListener('input', handleEmailChange);
            document.getElementById('searchInput').addEventListener('input', handleSearch);
        });

        // Load songs from Google Sheets (PUBLIC sheet - no API key needed!)
        async function loadSongsFromSheet() {
            try {
                // Using public Google Sheets CSV export - no API key needed!
                const url = `https://docs.google.com/spreadsheets/d/${TRACKS_SHEET_ID}/export?format=csv&gid=0`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Sheet not accessible');
                
                const csvText = await response.text();
                
                // Parse CSV
                const lines = csvText.split('\n');
                const loadedSongs = lines.slice(1)
                    .filter(line => line.trim())
                    .map((line, index) => {
                        const parts = line.split(',');
                        return {
                            id: index + 1,
                            artist: parts[0] ? parts[0].replace(/"/g, '').trim() : '',
                            title: parts[1] ? parts[1].replace(/"/g, '').trim() : ''
                        };
                    })
                    .filter(song => song.artist && song.title);
                
                // Only replace if we got valid data
                if (loadedSongs.length > 0) {
                    allSongs = loadedSongs;
                    console.log('Loaded', allSongs.length, 'tracks from Google Sheets');
                } else {
                    console.log('Using hardcoded tracks (no data in sheet)');
                }
                
                renderSongs();
            } catch (error) {
                console.error('Error loading tracks from sheet:', error);
                console.log('Using hardcoded tracks as fallback');
                renderSongs(); // Use the hardcoded songs
            }
        }

        function renderSongs(filteredSongs = allSongs) {
            const container = document.getElementById('songsList');
            
            if (allSongs.length === 0 && filteredSongs.length === 0) {
                return; // Still loading
            }
            
            if (filteredSongs.length === 0) {
                container.innerHTML = '<div class="empty-state">No tracks found matching your search.</div>';
                return;
            }
            
            container.innerHTML = filteredSongs.map(song => {
                const isSelected = selectedSongs.some(s => s.id === song.id);
                const canSelect = (selectedSongs.length + customSongs.length) < MAX_SELECTIONS || isSelected;
                
                return `
                    <div class="song-item ${isSelected ? 'selected' : ''} ${!canSelect ? 'disabled' : ''}" 
                         onclick="${canSelect ? `toggleSong(${song.id})` : ''}">
                        <div class="song-info">
                            <div class="song-title">${song.title}</div>
                            <div class="song-artist">${song.artist}</div>
                        </div>
                        ${isSelected ? '<span style="font-size: 1.5rem;">‚ù§Ô∏è</span>' : ''}
                    </div>
                `;
            }).join('');
        }

        function toggleSong(songId) {
            const song = allSongs.find(s => s.id === songId);
            const index = selectedSongs.findIndex(s => s.id === songId);
            
            if (index >= 0) {
                selectedSongs.splice(index, 1);
            } else {
                const total = selectedSongs.length + customSongs.length;
                if (total < MAX_SELECTIONS) {
                    selectedSongs.push(song);
                }
            }
            
            updateDisplay();
        }

        function addCustomSong() {
            const artist = document.getElementById('customArtist').value.trim();
            const title = document.getElementById('customTitle').value.trim();
            
            if (!artist || !title) {
                alert('Please enter both artist and title');
                return;
            }
            
            const total = selectedSongs.length + customSongs.length;
            if (total >= MAX_SELECTIONS || customSongs.length >= MAX_CUSTOM) {
                alert(`Maximum ${MAX_CUSTOM} custom tracks allowed`);
                return;
            }
            
            customSongs.push({
                id: `custom-${Date.now()}`,
                artist: artist,
                title: title,
                custom: true
            });
            
            document.getElementById('customArtist').value = '';
            document.getElementById('customTitle').value = '';
            toggleCustomForm();
            updateDisplay();
        }

        function removeSelection(id) {
            // Check if it's a custom song (string ID starting with 'custom-')
            if (typeof id === 'string' && id.startsWith('custom-')) {
                customSongs = customSongs.filter(s => s.id !== id);
            } else {
                // It's a regular song (numeric ID)
                selectedSongs = selectedSongs.filter(s => s.id !== parseInt(id));
            }
            updateDisplay();
        }

        function updateDisplay() {
            const total = selectedSongs.length + customSongs.length;
            
            // Update counter
            document.getElementById('selectionCounter').textContent = `Your Selections (${total}/${MAX_SELECTIONS})`;
            document.getElementById('customCount').textContent = customSongs.length;
            
            // Update selections list
            const container = document.getElementById('selectionsList');
            if (total === 0) {
                container.innerHTML = '<div class="empty-state">No tracks selected yet. Start building your list below!</div>';
            } else {
                const allSelected = [...selectedSongs, ...customSongs];
                container.innerHTML = allSelected.map((song, idx) => `
                    <div class="selected-item">
                        <span class="selected-number">${idx + 1}</span>
                        <div class="selected-info">
                            <div class="song-title">${song.title}</div>
                            <div class="song-artist">${song.artist} ${song.custom ? '<span class="custom-badge">Custom</span>' : ''}</div>
                        </div>
                        <button class="btn btn-remove" onclick="removeSelection(${song.custom ? "'" + song.id + "'" : song.id})">‚úï</button>
                    </div>
                `).join('');
            }
            
            // Refresh songs display
            const searchTerm = document.getElementById('searchInput').value;
            handleSearch({ target: { value: searchTerm } });
            
            // Update submit button
            updateSubmitButton();
        }

        function handleSearch(e) {
            const term = e.target.value.toLowerCase();
            const filtered = term ? 
                allSongs.filter(s => 
                    s.artist.toLowerCase().includes(term) || 
                    s.title.toLowerCase().includes(term)
                ) : allSongs;
            renderSongs(filtered);
        }

        function handleFormChange(e) {
            currentName = document.getElementById('nameInput').value.trim();
            currentPostcode = document.getElementById('postcodeInput').value.trim();
            currentAgeRange = document.getElementById('ageRangeSelect').value;
            updateSubmitButton();
        }

        function handleEmailChange(e) {
            currentEmail = e.target.value.trim();
            if (currentEmail.includes('@')) {
                checkIfVoted();
            } else {
                hasVoted = false;
                document.getElementById('votedAlert').classList.remove('show');
            }
            updateSubmitButton();
        }

        async function checkIfVoted() {
            // Check localStorage first
            const votes = JSON.parse(localStorage.getItem('votes') || '[]');
            hasVoted = votes.includes(currentEmail.toLowerCase());
            
            if (hasVoted) {
                document.getElementById('votedAlert').classList.add('show');
            } else {
                document.getElementById('votedAlert').classList.remove('show');
            }
            
            updateSubmitButton();
        }

        function updateSubmitButton() {
            const total = selectedSongs.length + customSongs.length;
            const btn = document.getElementById('submitBtn');
            const canSubmit = currentName && 
                             currentPostcode && 
                             currentAgeRange && 
                             currentEmail.includes('@') && 
                             total >= MIN_SELECTIONS && 
                             total <= MAX_SELECTIONS && 
                             !hasVoted;
            
            btn.disabled = !canSubmit;
        }

        function toggleCustomForm() {
            const form = document.getElementById('customForm');
            form.classList.toggle('show');
        }

        function saveShortlist() {
            const data = {
                name: currentName,
                postcode: currentPostcode,
                ageRange: currentAgeRange,
                email: currentEmail,
                selectedSongs: selectedSongs,
                customSongs: customSongs,
                savedAt: new Date().toISOString()
            };
            localStorage.setItem('voting-shortlist', JSON.stringify(data));
            alert('Shortlist saved! Your selections will be here when you return.');
        }

        function loadSavedShortlist() {
            const saved = localStorage.getItem('voting-shortlist');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (confirm('You have a saved shortlist. Would you like to restore it?')) {
                        currentName = data.name || '';
                        currentPostcode = data.postcode || '';
                        currentAgeRange = data.ageRange || '';
                        currentEmail = data.email || '';
                        selectedSongs = data.selectedSongs || [];
                        customSongs = data.customSongs || [];
                        
                        document.getElementById('nameInput').value = currentName;
                        document.getElementById('postcodeInput').value = currentPostcode;
                        document.getElementById('ageRangeSelect').value = currentAgeRange;
                        document.getElementById('emailInput').value = currentEmail;
                        
                        updateDisplay();
                        if (currentEmail) handleEmailChange({ target: { value: currentEmail } });
                    }
                } catch (e) {
                    console.error('Error loading shortlist:', e);
                }
            }
        }

        async function submitVote() {
            if (hasVoted) {
                alert('You have already voted with this email address');
                return;
            }

            const total = selectedSongs.length + customSongs.length;
            
            if (total < MIN_SELECTIONS) {
                alert(`Please select at least ${MIN_SELECTIONS} tracks to submit your vote.`);
                return;
            }
            
            if (total > MAX_SELECTIONS) {
                alert(`Please select no more than ${MAX_SELECTIONS} tracks.`);
                return;
            }

            const voteData = {
                name: currentName,
                postcode: currentPostcode,
                ageRange: currentAgeRange,
                email: currentEmail.toLowerCase(),
                timestamp: new Date().toISOString(),
                totalCount: total,
                selectedSongs: selectedSongs.map(s => `${s.artist} - ${s.title}`),
                customSongs: customSongs.map(s => `${s.artist} - ${s.title}`),
                allSongs: [...selectedSongs, ...customSongs].map(s => `${s.artist} - ${s.title}`)
            };

            try {
                // Disable submit button while processing
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Submitting...';

                // Save to localStorage (for backup/offline check)
                const votes = JSON.parse(localStorage.getItem('votes') || '[]');
                votes.push(currentEmail.toLowerCase());
                localStorage.setItem('votes', JSON.stringify(votes));

                const allVotes = JSON.parse(localStorage.getItem('allVotes') || '[]');
                allVotes.push(voteData);
                localStorage.setItem('allVotes', JSON.stringify(allVotes));

                // Check if URL is configured
                if (VOTES_SCRIPT_URL === 'PASTE_YOUR_GOOGLE_APPS_SCRIPT_URL_HERE' || !VOTES_SCRIPT_URL) {
                    console.error('Apps Script URL not configured');
                    alert('Google Apps Script URL is not configured. Please contact the administrator.\n\nYour vote has been saved locally as backup.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üì§ Submit Your Vote';
                    return;
                }

                console.log('Submitting to:', VOTES_SCRIPT_URL);
                console.log('Vote data:', voteData);

                // Create a hidden iframe to submit the form
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.name = 'vote-submit-iframe';
                document.body.appendChild(iframe);

                // Create a temporary form
                const form = document.createElement('form');
                form.target = 'vote-submit-iframe';
                form.method = 'POST';
                form.action = VOTES_SCRIPT_URL;

                // Add form fields
                const fields = {
                    name: voteData.name,
                    postcode: voteData.postcode,
                    ageRange: voteData.ageRange,
                    email: voteData.email,
                    timestamp: voteData.timestamp,
                    totalCount: voteData.totalCount,
                    allSongs: voteData.allSongs.join(', ')
                };

                Object.keys(fields).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = fields[key];
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit();

                // Clean up after a short delay
                setTimeout(() => {
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                }, 2000);

                // Assume success since we can't read the response
                const result = { success: true };

                // Check if submission was successful
                if (result.success === false) {
                    // Server rejected the vote (likely duplicate email)
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üì§ Submit Your Vote';
                    alert(result.error || 'This email has already been used to vote. Each person can only vote once.');
                    hasVoted = true;
                    document.getElementById('votedAlert').classList.add('show');
                    return;
                }

                // Show success
                document.getElementById('totalCount').textContent = total;
                
                // Populate vote list for image
                const allVotedSongs = [...selectedSongs, ...customSongs];
                const voteListHTML = allVotedSongs.map((song, idx) => `
                    <div class="vote-list-item">
                        <div class="vote-track">
                            <div class="vote-track-title">${song.title}</div>
                            <div class="vote-track-artist">${song.artist}</div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('voteListForImage').innerHTML = voteListHTML;
                
                document.getElementById('mainForm').style.display = 'none';
                document.getElementById('successScreen').classList.add('show');

                // Clear shortlist
                localStorage.removeItem('voting-shortlist');

            } catch (error) {
                console.error('Error submitting vote:', error);
                console.error('Error details:', error.message);
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = false;
                submitBtn.textContent = 'üì§ Submit Your Vote';
                
                // More detailed error message
                let errorMsg = 'Failed to submit vote.\n\n';
                if (error.message.includes('Failed to fetch')) {
                    errorMsg += 'Network error: Could not connect to server.\n';
                    errorMsg += 'Please check:\n';
                    errorMsg += '1. Your internet connection\n';
                    errorMsg += '2. That the Google Apps Script URL is correct\n';
                    errorMsg += '3. That the Apps Script is deployed as "Anyone" access\n\n';
                } else {
                    errorMsg += 'Error: ' + error.message + '\n\n';
                }
                errorMsg += 'Your vote has been saved locally as backup.';
                
                alert(errorMsg);
            }
        }

        // Download vote as image
        async function downloadVoteImage() {
            const voteCard = document.getElementById('voteCard');
            
            try {
                // Use html2canvas library (loaded from CDN)
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                document.head.appendChild(script);
                
                script.onload = async function() {
                    const canvas = await html2canvas(voteCard, {
                        backgroundColor: null,
                        scale: 2, // Higher quality
                        logging: false,
                        useCORS: true, // Enable CORS for external images
                        allowTaint: true
                    });
                    
                    // Convert to image and download
                    const link = document.createElement('a');
                    link.download = 'my-steel-city-50-votes.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                };
            } catch (error) {
                console.error('Error generating image:', error);
                alert('Failed to generate image. Please try again.');
            }
        }
    </script>
</body>
</html>
